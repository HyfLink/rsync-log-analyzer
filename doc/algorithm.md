# Rsync Log Analyzer - Algorithm

由于文件的同步是的，且是按照深度优先顺序遍历，因此日志的时间差可以反应一个或多个连续文件同步耗时。以下述输入为例。

```text
2023/07/04 03:40:31 [14417] cd+++++++++ A0/
2023/07/04 03:40:31 [14417] >f+++++++++ A0/B0/
2023/07/04 03:40:31 [14417] >f+++++++++ A0/B0/F0.txt
2023/07/04 03:40:34 [14417] >f+++++++++ A0/B0/F1.txt
2023/07/04 03:40:35 [14417] cd+++++++++ A0/B1/
2023/07/04 03:40:35 [14417] >f+++++++++ A0/B1/F2.txt
2023/07/04 03:40:37 [14417] >f+++++++++ A0/B1/F3.txt
2023/07/04 03:40:38 [14417] cd+++++++++ A1/
```

一个文件的同步时间，等于下一条日志的时刻减去当前日志的时刻。

- 文件`A0/B0/F0.txt`同步时间为`2023/07/04 03:40:34`-`2023/07/04 03:40:31`=`3`秒
- 文件`A0/B0/F1.txt`同步时间为`2023/07/04 03:40:35`-`2023/07/04 03:40:34`=`1`秒
- 文件`A0/B1/F2.txt`同步时间为`2023/07/04 03:40:37`-`2023/07/04 03:40:35`=`2`秒
- 文件`A0/B1/F3.txt`同步时间为`2023/07/04 03:40:38`-`2023/07/04 03:40:37`=`1`秒

一个文件夹的同步时间，等于所有子目录项同步时间之和，也等于下一个非子目录的开始时刻减去当前目录的时刻。

- 文件夹`A0/B0`同步时间为`2023/07/04 03:40:35`(`A0/B1`的开始时刻)-`2023/07/04 03:40:31`=`4`秒
- 文件夹`A0/B1`同步时间为`2023/07/04 03:40:38`(`A1`的开始时刻)-`2023/07/04 03:40:35`=`3`秒
- 文件夹`A0`同步时间为`2023/07/04 03:40:38`(`A1`的开始时刻)-`2023/07/04 03:40:31`=`7`秒

另外，最后一个项目无法通过时间差计算其同步时间，我们视其同步时间为`0`秒.

我们通过维护一个栈来存储当前目录项解析情况。逐行遍历整个日志文件，每行包括了一个目录项的起始同步时刻、类别（文件或文件夹）、路径。我们按字符`'/'`将目录分割为若干部分，如路径`A0/B0/F0.txt`可以分为`A0`、`B0`、`F0.txt`三部分。按照以下规制对我们维护的栈进行操作。

- 初始时栈为空。栈中的每一项保存一个路径部分、其同步时刻。如解析文件夹`A0/B1`后，栈中有两个元素：

  1. 路径部分`A0`、同步时刻`2023/07/04 03:40:31`
  1. 路径部分`B1`、同步时刻`2023/07/04 03:40:35`

- 若栈中保存的目录是当前路径的前缀（或栈为空），则将当前路径的最后一项入栈。

  如当前栈中内容为`A0`、`B0`，当前路径为`A0/B0/F0.txt`，则将`F0.txt`入栈。最终栈中为`A0`、`B0`、`F0.txt`。

- 若栈中保存的目录是不是当前路径的前缀，则重复出栈，直到栈中保存的目录是当前路径的前缀（或栈为空），然后将当前路径的最后一项入栈。

  如当前栈中内容为`A0`、`B0`、`F1.txt`，当前路径为`F0/B1`，则将`F1.txt`、`B0`出栈，然后将`B1`入栈。最终栈中为`A0`、`B1`。

- 每次有元素出栈，则表示其同步耗时可以计算，时间为“当前路径的同步时刻”减去“栈节点保存的时刻”。

- 若日志文件已经读取完毕，而栈中仍然有元素。则将栈顶元素的同步时刻视为“同步结束时刻”。栈中每个元素的同步时间为“同步结束时刻”减去“栈节点保存的时刻”。

如此，可以保证：

- 遍历完成后，每行路径都会入栈。

- 遍历完成后，每行路径都会出栈，且出栈时计算其同步时间。

- 最后一项的同步时间为0，因为其同步起始时刻被当作了结束时刻。

- 文件同步时间的计算不会被当作文件夹，因为文件的路径不可能是其他路径的前缀（如此便不必区别对待文件和文件夹）。
